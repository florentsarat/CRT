{
  "designerVersion" : "1.9.53",
  "id" : "customFromIniateAssignandStartFirstHumanTask",
  "name" : "FromIniateAssignandStartFirstHumanTask",
  "lastUpdate" : 1569413633763,
  "template" : "",
  "controller" : "function($scope, $interval, $window, $http, $modal) {\n    var ctrl = this;\n    $scope.display = \"display:none\";\n\n\n    ctrl.firstTime = true;\n    \n    // Current user id\n    var userId;\n\n    // Current case id\n    var caseId;\n\n    // Get current user id by performing a call to /API/system/session\n    $http.get('/' + $scope.properties.bonitaWebAppName + '/API/system/session/1').\n    success(function(data, status, header, config) {\n        // Get the user id from REST API call answer\n        userId = data.user_id;\n    }).\n    error(function(data, status, headers, config) {\n        return;\n    });\n    $scope.$watch('properties.submitButtonSuccessfulResponseValue', function() {\n        if (!ctrl.firstTime) {\n            console.log(\"Second click\"); \n            //Get case ID from submit\n            var counter = 0, interval = $interval(function() {\n                counter++;\n                if (counter > 10) {\n                    $interval.cancel(interval);\n                    console.log(\"Fail\");\n                }\n                else {\n                    caseId = $scope.properties.submitButtonSuccessfulResponseValue.caseId;\n                     console.log(\"Case ID is \" + caseId); \n                    // Call API to get pending task (limit result to one task) for current user in current case\n                    $http.get('/' + $scope.properties.bonitaWebAppName + '/API/bpm/humanTask?c=1&p=0&f=state=ready&f=user_id=' + userId + '&f=caseId=' + caseId).\n                    success(function(data, status, headers, config) {\n                        if (data[0]) {\n                            //assign\n                            console.log(\"Assign \" + data[0]);\n                            $http.put('/' + $scope.properties.bonitaWebAppName + '/API/bpm/humanTask/' + data[0].id, {assigned_id: userId});\n                            // Redirect user to task form\n                        $window.location.href = '/' + $scope.properties.bonitaWebAppName + '/portal/form/taskInstance/' + data[0].id;\n                        }\n                    }).\n                    error(function(data, status, headers, config) {\n                    });\n                }\n            }, 500);\n        } \n        else {\n            // This is the first time submitButtonSuccessfulResponseValue changed\n            ctrl.firstTime = false;\n        }\n    });\n\n}",
  "custom" : true,
  "properties" : [ {
    "label" : "Submit button successful response value",
    "name" : "submitButtonSuccessfulResponseValue",
    "type" : "text",
    "bond" : "expression"
  }, {
    "label" : "Bonita web app name",
    "name" : "bonitaWebAppName",
    "type" : "text",
    "defaultValue" : "bonita",
    "bond" : "expression"
  } ],
  "assets" : [ ],
  "requiredModules" : [ "ui.bootstrap" ],
  "type" : "widget",
  "hasHelp" : false
}